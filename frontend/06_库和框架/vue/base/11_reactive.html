<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>11_reactive</title>
</head>
<body>
    <div id="app"></div>

    <script>
        function defineReactive(obj, key) {
            const dep = new Dep();
            let val = obj[key];

            // 深度 reactive
            let childOb = observe(val);

            // 当前 key
            Object.defineProperty(obj, key, {
                enumerable: true,
                configurable: true,
                get: function () {
                    if (Dep.target) {
                        dep.depend();

                        // 子属性依赖收集
                        if (childOb) {
                            childOb.dep.depend();
                        }
                    }

                    return val;
                },
                set: function (newVal) {
                    val = newVal;
                    dep.notify();
                }
            });
        }
        
        // 引用类型深度 reactive
        function observe(value) {
            if (value !== null && typeof value === 'object') {
                let ob = null;

                if (value.hasOwnProperty('__ob__')) {
                    ob = value.__ob__;
                } else {
                    ob = new Observer(value);
                }

                return ob;
            }
        }
    </script>

    <script>
        class Observer {
            constructor(value) {
                this.value = value;
                this.dep = new Dep();

                Object.defineProperty(value, '__ob_', {
                    enumerable: false,
                    value: this
                });

                if (Array.isArray(value)) {
                    this.observeArray(value);
                } else {
                    this.walk(value);
                }
            }

            walk(obj) {
                Object.keys(obj).forEach(function (key) {
                    defineReactive(obj, key);
                });
            }

            observeArray(items) {

            }
        }

        class Dep {
            constructor() {
                this.subs = []; // Watcher 集合
            }

            // 依赖收集
            depend() {
                if (Dep.target) {
                    Dep.target.addDep(this);
                }
            }

            addSub(watcher) {
                this.subs.push(watcher);
            }

            // 更新通知
            notify() {
                console.log('Dep: property changed notify!');
                const subs = this.subs.slice();
                subs.forEach(function (sub) {
                    sub.update();
                });
            }
        }

        class Watcher {
            constructor(vm, updateComponent) {
                this.newDeps = []; // Dep 集合
                this.vm = vm;
                this.getter = updateComponent; // 组件更新函数

                // 每次 new 就会 利用 getter 去 get 所有属性，从而进行每个属性的依赖收集
                Dep.target = this;
                this.value = this.getter.call(vm, vm);
                // 收集完后，清除 target
                Dep.target = null;
            }

            addDep(dep) {
                this.newDeps.push(dep);
                dep.addSub(this);
            }

            // 响应依赖变化
            update() {
                console.log('Watcher: property changed update!');
                this.getter.call(this.vm, this.vm);
            }
        }

        // 组件
        class MyComponent {
            constructor(data) {
                this.$data = {};

                // reactive
                for (let key in data) {
                    this[key] = data[key];
                    this.$data[key] = data[key];
                    defineReactive(this, key);
                }

                // 创建 Watcher，绑定组件实例
                new Watcher(this, this.render);
            }

            render() {
                // 渲染
                document.querySelector('#app').innerHTML = `
                    <div>name: ${this.name}</div>
                    <div>age: ${this.age}</div>
                    <div>school: ${JSON.stringify(this.school)}</div>
                    <div>school.locate: ${this.school.locate}</div>
                    <div>school.detail: ${JSON.stringify(this.school.detail)}</div>
                    <div>school.detail.name: ${this.school.detail.name}</div>
                    <div>school.detail.age: ${this.school.detail.age}</div>
                    <div>school.detail.desc: ${this.school.detail.desc}</div>
                `;
            }
        }
    </script>

    <script>
        const comp = new MyComponent({
            name: 'Jay',
            age: 18,
            school: {
                locate: 'GuangZhou',
                detail: {
                    name: 'First Scholl',
                    age: 100,
                    desc: 'Very Good!'
                }
            }
        });
    </script>
</body>
</html>